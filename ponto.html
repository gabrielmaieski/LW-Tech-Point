<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Ponto - LW TECH</title>
    <style>
        :root {
            --cor-primaria: #002A5A;
            --cor-secundaria: #0056b3;
            --cor-fundo: #F4F6F8;
            --cor-texto: #333333;
            --cor-sucesso: #28a745;
            --cor-aviso: #ffc107;
            --cor-info: #17a2b8;
            --cor-perigo: #dc3545;
            --sombra-card: 0 8px 24px rgba(0, 42, 90, 0.1);
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--cor-fundo);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: var(--cor-texto);
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: var(--sombra-card);
            width: 100%;
            max-width: 600px;
            text-align: center;
            border-top: 5px solid var(--cor-secundaria);
            position: relative;
        }

        .logo-lwsa {
            max-width: 180px;
            height: auto;
            margin-bottom: 20px;
            margin-top: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        h2 { color: var(--cor-primaria); margin-bottom: 5px; font-weight: 600; }
        p { color: #666; margin-bottom: 20px; font-size: 14px; }

        /* Inputs */
        .campo-form { margin-bottom: 15px; text-align: left; }
        .campo-form label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 12px; }
        
        input[type="text"], input[type="password"] {
            width: 100%; padding: 12px;
            border: 1px solid #ccc; border-radius: 4px; font-size: 16px;
            box-sizing: border-box; transition: border-color 0.3s;
        }
        input:focus { outline: none; border-color: var(--cor-secundaria); }

        /* Bot칫es */
        button {
            padding: 12px; font-size: 15px; font-weight: 600;
            border: none; border-radius: 4px; cursor: pointer; color: white;
            transition: opacity 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover { opacity: 0.9; }

        .btn-login { background-color: var(--cor-primaria); width: 100%; margin-top: 10px; }
        .btn-verde { background-color: var(--cor-sucesso); }
        .btn-vermelho { background-color: var(--cor-perigo); }
        .btn-amarelo { background-color: var(--cor-aviso); color: #333; }
        .btn-laranja { background-color: #fd7e14; }
        .btn-azul { background-color: var(--cor-info); }
        .btn-escuro { background-color: #343a40; }

        .btn-relatorio { 
            background-color: white; color: var(--cor-primaria); 
            border: 1px solid var(--cor-primaria); margin-top: 15px; width: 100%;
        }

        .btn-sair { 
            background: none; border: none; color: #999; 
            font-size: 12px; text-decoration: underline; padding: 0; box-shadow: none;
        }

        /* Estrutura */
        .tela { display: none; }
        .tela.ativa { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .grid-botoes { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        
        .relogio { font-size: 2.5em; font-weight: 300; color: var(--cor-primaria); margin: 15px 0; }
        
        .painel-info {
            background-color: #f8f9fa; border-left: 4px solid var(--cor-secundaria);
            padding: 10px; margin-bottom: 20px; text-align: left; border-radius: 4px;
        }

        /* Lista Hist칩rico */
        ul { list-style: none; padding: 0; text-align: left; max-height: 150px; overflow-y: auto; border: 1px solid #eee; }
        li { background: white; border-bottom: 1px solid #f0f0f0; padding: 10px; font-size: 13px; display: flex; justify-content: space-between; }
        .badge { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }

        /* Tabela Admin */
        .tabela-container { max-height: 300px; overflow-y: auto; margin-top: 10px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f1f1f1; color: #555; position: sticky; top: 0; }
        tr:nth-child(even) { background-color: #f9f9f9; }

    </style>
</head>
<body>

    <div class="container">
        
        <img src="image_b2e9b6.png" alt="Logo LWSA" class="logo-lwsa">
        
        <div id="tela-login" class="tela ativa">
            <p>Identifique-se para marcar o ponto.</p>
            
            <div class="campo-form">
                <label>Usu치rio</label>
                <input type="text" id="input-usuario" placeholder="Ex: joao, maria, admin">
            </div>
            
            <div class="campo-form">
                <label>Senha (PIN)</label>
                <input type="password" id="input-senha" placeholder="Sua senha secreta">
            </div>
            
            <p style="font-size: 11px; color: #999;">*Primeiro acesso cria a conta automaticamente.</p>

            <button class="btn-login" onclick="processarLogin()">ENTRAR</button>
        </div>

        <div id="tela-funcionario" class="tela">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div style="text-align: left;">
                    <span style="font-size: 12px; color: #999;">FUNCION츼RIO</span><br>
                    <span id="nome-funcionario" style="font-weight: bold; color: var(--cor-primaria); font-size: 18px;">--</span>
                </div>
                <button class="btn-sair" onclick="fazerLogout()">Sair</button>
            </div>
            
            <div class="relogio" id="relogio-func">00:00:00</div>
            
            <div class="painel-info">
                <span style="font-size: 11px; color:#777;">TEMPO TRABALHADO HOJE</span><br>
                <span id="horas-trabalhadas" style="font-size: 24px; font-weight: bold;">00:00</span>
            </div>

            <div class="grid-botoes">
                <button class="btn-verde" onclick="registrar('Entrada')">Entrada</button>
                <button class="btn-vermelho" onclick="registrar('Sa칤da')">Sa칤da</button>
                <button class="btn-amarelo" onclick="registrar('Ida Almo칞o')">Almo칞o (Ida)</button>
                <button class="btn-laranja" onclick="registrar('Volta Almo칞o')">Almo칞o (Volta)</button>
                <button class="btn-azul" onclick="registrar('Ida Pausa 10min')">Pausa 10 (Ida)</button>
                <button class="btn-azul" style="filter: brightness(0.9);" onclick="registrar('Volta Pausa 10min')">Pausa 10 (Volta)</button>
            </div>

            <ul id="lista-registos"></ul>
            <button class="btn-relatorio" onclick="baixarRelatorioPessoal()">Exportar Meus Pontos</button>
        </div>

        <div id="tela-admin" class="tela">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin:0;">Painel de Gest칚o</h2>
                <button class="btn-sair" onclick="fazerLogout()">Sair</button>
            </div>

            <div class="painel-info" style="border-color: #333;">
                <span style="font-weight: bold;">Resumo Geral</span>
                <p style="margin: 5px 0 0 0;">Total de Registos no Sistema: <span id="admin-total-registos">0</span></p>
            </div>

            <div style="text-align: left; margin-bottom: 5px;"><strong>칔ltimos Registos (Todos)</strong></div>
            
            <div class="tabela-container">
                <table id="tabela-admin">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Usu치rio</th>
                            <th>A칞칚o</th>
                        </tr>
                    </thead>
                    <tbody id="corpo-tabela-admin">
                        </tbody>
                </table>
            </div>

            <button class="btn-relatorio" style="background-color: var(--cor-primaria); color: white;" onclick="baixarRelatorioGeral()">
                游늯 Baixar Relat칩rio Completo (Todos)
            </button>
        </div>

    </div>

    <script>
        // BANCO DE DADOS NA MEM칍RIA
        let usuarioLogado = null;
        let tipoUsuario = 'padrao'; // 'padrao' ou 'admin'

        // Carrega dados ou cria novo
        let dbRegistos = JSON.parse(localStorage.getItem('ponto_registos')) || [];
        let dbUsuarios = JSON.parse(localStorage.getItem('ponto_usuarios')) || { 
            'admin': '1234' // Cria utilizador admin padr칚o
        }; 

        // 1. SISTEMA DE LOGIN E SENHA
        function processarLogin() {
            const usuario = document.getElementById('input-usuario').value.trim().toLowerCase();
            const senha = document.getElementById('input-senha').value.trim();

            if (!usuario || !senha) {
                alert("Preencha utilizador e senha.");
                return;
            }

            // Verifica se utilizador existe
            if (dbUsuarios[usuario]) {
                // Utilizador existe, conferir senha
                if (dbUsuarios[usuario] === senha) {
                    entrarNoSistema(usuario);
                } else {
                    alert("Senha incorreta!");
                }
            } else {
                // Utilizador N츾O existe -> Criar conta (Registo)
                if(confirm(`O utilizador "${usuario}" n칚o existe. Deseja criar uma conta com essa senha?`)) {
                    dbUsuarios[usuario] = senha;
                    localStorage.setItem('ponto_usuarios', JSON.stringify(dbUsuarios));
                    alert("Conta criada com sucesso! A entrar...");
                    entrarNoSistema(usuario);
                }
            }
        }

        function entrarNoSistema(usuario) {
            usuarioLogado = usuario;
            document.getElementById('input-usuario').value = '';
            document.getElementById('input-senha').value = '';
            document.getElementById('tela-login').classList.remove('ativa');

            if (usuario === 'admin') {
                tipoUsuario = 'admin';
                document.getElementById('tela-admin').classList.add('ativa');
                carregarPainelAdmin();
            } else {
                tipoUsuario = 'padrao';
                document.getElementById('tela-funcionario').classList.add('ativa');
                // Formata o nome (primeira letra mai칰scula)
                document.getElementById('nome-funcionario').innerText = usuario.charAt(0).toUpperCase() + usuario.slice(1);
                atualizarTelaFuncionario();
            }
        }

        function fazerLogout() {
            usuarioLogado = null;
            tipoUsuario = null;
            document.querySelectorAll('.tela').forEach(t => t.classList.remove('ativa'));
            document.getElementById('tela-login').classList.add('ativa');
        }

        // 2. FUN칂칏ES DO FUNCION츼RIO
        function registrar(tipo) {
            const agora = new Date();
            const registo = {
                usuario: usuarioLogado,
                tipo: tipo,
                dataHora: agora.toISOString(),
                dataLegivel: agora.toLocaleDateString('pt-BR'),
                horaLegivel: agora.toLocaleTimeString('pt-BR')
            };

            dbRegistos.push(registo);
            localStorage.setItem('ponto_registos', JSON.stringify(dbRegistos));
            atualizarTelaFuncionario();
        }

        function atualizarTelaFuncionario() {
            // Atualiza lista visual
            const lista = document.getElementById('lista-registos');
            lista.innerHTML = '';
            const hoje = new Date().toLocaleDateString('pt-BR');
            
            // Filtra meus registos de hoje
            const meusRegistros = dbRegistos.filter(r => r.usuario === usuarioLogado && r.dataLegivel === hoje);

            meusRegistros.forEach(reg => {
                let cor = '#ccc';
                if(reg.tipo === 'Entrada') cor = '#28a745';
                else if(reg.tipo === 'Sa칤da') cor = '#dc3545';
                else if(reg.tipo.includes('Pausa')) cor = '#17a2b8';
                else cor = '#ffc107';

                const li = document.createElement('li');
                li.innerHTML = `<div><span class="badge" style="background-color:${cor}"></span>${reg.tipo}</div> <strong>${reg.horaLegivel}</strong>`;
                lista.appendChild(li);
            });

            calcularHorasTrabalhadas(meusRegistros);
        }

        function calcularHorasTrabalhadas(registros) {
            let msTrabalhados = 0;
            let inicioTemp = null;
            
            registros.sort((a, b) => new Date(a.dataHora) - new Date(b.dataHora));

            registros.forEach(reg => {
                const tempo = new Date(reg.dataHora).getTime();

                // L칩gica START (Entrada, Voltas)
                if (['Entrada', 'Volta Almo칞o', 'Volta Pausa 10min'].includes(reg.tipo)) {
                    if (inicioTemp === null) inicioTemp = tempo;
                }
                // L칩gica STOP (Sa칤da, Idas)
                else if (['Sa칤da', 'Ida Almo칞o', 'Ida Pausa 10min'].includes(reg.tipo)) {
                    if (inicioTemp !== null) {
                        msTrabalhados += (tempo - inicioTemp);
                        inicioTemp = null;
                    }
                }
            });

            const totalSegundos = Math.floor(msTrabalhados / 1000);
            const horas = Math.floor(totalSegundos / 3600);
            const minutos = Math.floor((totalSegundos % 3600) / 60);
            document.getElementById('horas-trabalhadas').innerText = `${horas.toString().padStart(2,'0')}h ${minutos.toString().padStart(2,'0')}m`;
        }

        function baixarRelatorioPessoal() {
            gerarCSV(dbRegistos.filter(r => r.usuario === usuarioLogado), `relatorio_${usuarioLogado}.csv`);
        }

        // 3. FUN칂칏ES DO ADMIN (CHEFE)
        function carregarPainelAdmin() {
            document.getElementById('admin-total-registos').innerText = dbRegistos.length;
            
            const tbody = document.getElementById('corpo-tabela-admin');
            tbody.innerHTML = '';

            // Copia o array e inverte para mostrar os mais recentes primeiro
            const todosInvertidos = [...dbRegistos].reverse(); 

            todosInvertidos.forEach(reg => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${reg.dataLegivel} ${reg.horaLegivel}</td>
                    <td style="font-weight:bold; color: #002A5A;">${reg.usuario}</td>
                    <td>${reg.tipo}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function baixarRelatorioGeral() {
            gerarCSV(dbRegistos, "relatorio_GERAL_empresa.csv");
        }

        // Fun칞칚o Utilit치ria para Download
        function gerarCSV(dados, nomeArquivo) {
            if (dados.length === 0) { alert("Sem dados para exportar."); return; }
            let csv = "Data,Hora,Usuario,Tipo\n";
            dados.forEach(r => {
                csv += `${r.dataLegivel},${r.horaLegivel},${r.usuario},${r.tipo}\n`;
            });
            
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI("data:text/csv;charset=utf-8," + csv));
            link.setAttribute("download", nomeArquivo);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Rel칩gio geral
        setInterval(() => {
            const timeString = new Date().toLocaleTimeString('pt-BR');
            if(document.getElementById('relogio-func')) document.getElementById('relogio-func').innerText = timeString;
        }, 1000);

    </script>
</body>
</html>